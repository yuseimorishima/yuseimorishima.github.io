<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒãƒ«ã‚®ãƒ¼è§£æãƒ„ãƒ¼ãƒ« - æ™‚é–“å¸¯å¯¾å¿œç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .map-section {
            flex: 1;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .sidebar {
            width: 450px;
            background: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab-button.active {
            color: #0066cc;
            border-bottom-color: #0066cc;
            background: #f9f9f9;
        }
        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .control-group {
            margin-bottom: 20px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }
        .control-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        .season-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
        }
        .season-btn {
            padding: 8px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .season-btn.active {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
        }
        .season-btn:hover {
            border-color: #0066cc;
        }
        .time-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .time-display .time-value {
            font-size: 18px;
            font-weight: bold;
            color: #0066cc;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #0066cc;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #0066cc;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .result-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .energy-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .result-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .result-location {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        .result-description {
            font-size: 12px;
            color: #555;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 280px;
            margin-bottom: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        .time-based-chart {
            position: relative;
            height: 250px;
            margin-bottom: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 400px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-message {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            line-height: 1.6;
        }
        .button {
            width: 100%;
            padding: 10px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
            margin-top: 10px;
        }
        .button:hover {
            background: #0052a3;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        .compare-list {
            margin-bottom: 15px;
        }
        .compare-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .compare-item-remove {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .compare-results {
            margin-top: 15px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
        }
        .result-item {
            padding: 8px;
            margin-bottom: 8px;
            background: white;
            border-radius: 4px;
            font-size: 12px;
        }
        .result-item strong {
            color: #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-section">
            <div id="map"></div>
        </div>
        
        <div class="sidebar">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('analyze')">åœ°ç‚¹è§£æ</button>
                <button class="tab-button" onclick="switchTab('compare')">æ¯”è¼ƒ (<span id="compareCount">0</span>)</button>
            </div>
            
            <div id="analyze-tab" class="tab-content active">
                <div class="control-group">
                    <label>è§£æå­£ç¯€</label>
                    <div class="season-buttons">
                        <button class="season-btn active" onclick="setSeason('spring')">æ˜¥</button>
                        <button class="season-btn" onclick="setSeason('summer')">å¤</button>
                        <button class="season-btn" onclick="setSeason('autumn')">ç§‹</button>
                        <button class="season-btn" onclick="setSeason('winter')">å†¬</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="time-display">
                        <label>è§£ææ™‚é–“å¸¯</label>
                        <span class="time-value"><span id="timeValue">12</span>:00</span>
                    </div>
                    <input type="range" id="timeSlider" min="0" max="23" value="12" onchange="updateTime(this.value)">
                </div>
                
                <div id="result-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ—ºï¸</div>
                        <p>åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è§£æã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>
            
            <div id="compare-tab" class="tab-content">
                <div class="compare-list" id="compareList"></div>
                <button class="button" onclick="executeComparison()" id="compareButton" disabled>ç·åˆæ¯”è¼ƒã‚’å®Ÿè¡Œ</button>
                <div id="compareResults"></div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <div class="loading-message" id="loadingMessage">è§£æä¸­...</div>
        </div>
    </div>

    <script>
        const LOADING_MESSAGES = [
            "ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å¦–ç²¾ãŸã¡ãŒä¼šè­°ã‚’è¡Œã£ã¦ã„ã¾ã™...",
            "è†¨å¤§ãªãƒ‡ãƒ¼ã‚¿ã®ä¸­ã§ã€æ‹…å½“AIãŒè¿·å­ã«ãªã£ã¦ã„ã¾ã™ã€‚ä»Šã™ãæ•‘å‡ºï¼ˆè§£æï¼‰ã—ã¾ã™ï¼",
            "ã‚µãƒ¼ãƒãƒ¼ãŒçŸ¥æµç†±ã‚’å‡ºã•ãªã„ç¨‹åº¦ã«å…¨åŠ›ç–¾èµ°ä¸­ã§ã™ã€‚",
            "äººå·¥è¡›æ˜Ÿã‹ã‚‰åœ°è¡¨ã®ç†±æºã‚’å‡è¦–ã—ã¦ã„ã¾ã™ã€‚ã¾ã°ãŸãå³ç¦...",
            "åœ°çƒã®é¼“å‹•ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ä¸­ã€‚å°‘ã€…ãŠå¾…ã¡ã‚’ã€‚",
            "1ã¨0ã®æµ·ã‹ã‚‰ã€ã‚ãªãŸã«æœ€é©ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã®çœŸç ã‚’ã™ãã„ä¸Šã’ã¦ã„ã¾ã™ã€‚",
            "ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’ä¸€å£é£²ã‚€æ™‚é–“ã¯ã‚ã‚Šã¾ã™ã€‚ã§ã‚‚äºŒå£ç›®ã¯é–“ã«åˆã‚ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚",
            "æœªæ¥ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è¨ˆç®—ä¸­... å¾…ã£ã¦ã„ã‚‹é–“ã«ã€ã‚ãªãŸã®è„³å†…ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚‚å……é›»ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚",
            "ã“ã®é–“ã«ã€åœ°çƒã®è£å´ã§ã¯å¤ªé™½ãŒæ²ˆã¿ã€é¢¨ãŒå¹ãå§‹ã‚ã¦ã„ã¾ã™ã€‚",
            "AIãŒãã‚ã°ã‚“ã‚’å¼¾ãã™ãã¦æŒ‡ã‚’ç«å‚·ã—ã‹ã‘ã¦ã„ã¾ã™...",
            "0ã¨1ã®æ³¢ã«æ‰ã¾ã‚Œã¦ã€æ‹…å½“è€…ãŒå°‘ã—èˆ¹é…”ã„æ°—å‘³ã§ã™...",
            "ã‚µãƒ¼ãƒãƒ¼ãŒçŸ¥æµç†±ã‚’å‡ºã—ãŸã®ã§ã€å†·ãˆãƒ”ã‚¿ã‚’è²¼ã‚ŠãªãŒã‚‰è¨ˆç®—ã—ã¦ã„ã¾ã™...",
            "è§£æã‚¨ãƒ³ã‚¸ãƒ³ãŒã€ã‚ã¨5ç§’ã ã‘å¯ã‹ã›ã¦ã€ã¨è¨€ã£ã¦ã„ã¾ã™ãŒã€å©ãèµ·ã“ã—ã¾ã—ãŸã€‚",
            "äººå·¥è¡›æ˜Ÿã‚’2ã€3å°å€Ÿã‚Šã¦ã€ç¾åœ°ã®é›²ã®éš™é–“ã‚’è¦—ãè¾¼ã‚“ã§ã„ã¾ã™...",
            "åœ°çƒã®è£å´ã¾ã§åœ°ç†±ã‚’æ¢ã—ã«è¡Œã£ã¦ã„ã¾ã™ã€‚ã™ãæˆ»ã‚Šã¾ã™ã€‚",
            "å¾³å·åŸ‹è”µé‡‘ã§ã¯ãªãã€å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®é‡‘è„ˆã‚’æ¢ã‚Šå½“ã¦ã‚ˆã†ã¨ã—ã¦ã„ã¾ã™...",
            "åŠå¾„500kmä»¥å†…ã®çŒ«ã®æ¯›ã®é€†ç«‹ã¡å…·åˆã‹ã‚‰ã€é™é›»æ°—ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’æ¸¬å®šä¸­...ï¼ˆå˜˜ã§ã™ï¼‰",
            "å¤§ä¸ˆå¤«ã§ã™ã€ãƒ•ãƒªãƒ¼ã‚ºã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚ãªãŸãŒé¸ã‚“ã åœŸåœ°ãŒé­…åŠ›çš„ã™ãã¦è¦‹æƒšã‚Œã¦ã„ã‚‹ã ã‘ã§ã™ã€‚",
            "ã‚³ãƒ¼ãƒ’ãƒ¼ã®æº–å‚™ã¯ã„ã„ã§ã™ã‹ï¼Ÿè±†ã‚’æŒ½ãæ™‚é–“ã¯ã‚ã‚Šã¾ã™ãŒã€ãŠæ¹¯ãŒæ²¸ãå‰ã«ã¯çµ‚ã‚ã‚Šã¾ã™ã€‚",
            "ä»Šã“ã®ç¬é–“ã€ã‚ãªãŸã®ã‚¯ãƒªãƒƒã‚¯ãŒæ—¥æœ¬ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®æœªæ¥ã‚’å¤‰ãˆã‚‹ï¼ˆã‹ã‚‚ã—ã‚Œãªã„ï¼‰ä¸€æ­©ã«ãªã‚Šã¾ã—ãŸã€‚",
            "è§£æä¸­... å¾…ã£ã¦ã„ã‚‹é–“ã«ã€èƒŒç­‹ã‚’ä¼¸ã°ã—ã¦æ·±å‘¼å¸ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ãã‚ŒãŒäººé–“ã«ã¨ã£ã¦ã®å†ã‚¨ãƒã§ã™ã€‚",
            "å·¨å¤§ãªæ›¸åº«ã‹ã‚‰ã€ãƒ›ã‚³ãƒªã‚’è¢«ã£ãŸæœ€æ–°çµ±è¨ˆã‚’å¼•ã£å¼µã‚Šå‡ºã—ã¦ã„ã¾ã™...",
            "çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãŸã¡ãŒã€ä¿ºã‚’ã‚°ãƒ©ãƒ•ã«ã—ã¦ãã‚Œï¼ã€ã¨åˆ—ã‚’ä½œã£ã¦ä¸¦ã‚“ã§ã„ã¾ã™...",
            "0.0001%ã®èª¤å·®ã‚‚è¨±ã•ãªã„æ½”ç™–ç—‡ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒã€æœ€å¾Œã®ãƒã‚§ãƒƒã‚¯ã‚’ã—ã¦ã„ã¾ã™..."
        ];

        const MASTER_DATA = {
            GEO_FLASH: { n: "åœ°ç†±ï¼ˆå¤§å®¹é‡ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰", c: "#c0392b", t: "ç«å±±å¸¯ã®å¼·åŠ›ãªè’¸æ°—ã‚’æ´»ç”¨ã™ã‚‹å®‰å®šé›»æºã€‚24æ™‚é–“å®‰å®šã—ãŸå‡ºåŠ›ãŒå¯èƒ½ã§ã™ã€‚", stable: 5, cost: 3, env: 5, future: 4 },
            GEO_BINARY: { n: "æ¸©æ³‰å…±ç”Ÿå‹ãƒã‚¤ãƒŠãƒªãƒ¼åœ°ç†±", c: "#e67e22", t: "æ¸©æ³‰è³‡æºã‚’ä¿è­·ã—ã¤ã¤ç™ºé›»ã€‚è¦³å…‰ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼è‡ªçµ¦ã‚’ä¸¡ç«‹ã•ã›ã¾ã™ã€‚", stable: 5, cost: 2, env: 5, future: 4 },
            WIND_OFFSHORE: { n: "æµ®ä½“å¼æ´‹ä¸Šé¢¨åŠ›ç™ºé›»", c: "#2980b9", t: "æµ·ä¸Šã®å¼·åŠ›ãªé¢¨ã‚’åŠ¹ç‡ã‚ˆãé›»æ°—ã«å¤‰ãˆã¾ã™ã€‚å°†æ¥ã®ä¸»åŠ›é›»æºã¨ã—ã¦æœŸå¾…ã•ã‚Œã¾ã™ã€‚", stable: 3, cost: 2, env: 4, future: 5 },
            WIND_ONSHORE: { n: "é™¸ä¸Šé¢¨åŠ›ç™ºé›»", c: "#3498db", t: "ä¸˜é™µãƒ»å¹³åŸåœ°å¸¯ã§å±•é–‹ã€‚åœ°åŸŸã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ä¸»è»¸ã‚’æ‹…ã†ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚", stable: 3, cost: 4, env: 4, future: 3 },
            SOLAR_ROOF: { n: "ãƒšãƒ­ãƒ–ã‚¹ã‚«ã‚¤ãƒˆå¤ªé™½å…‰", c: "#f1c40f", t: "ãƒ“ãƒ«å£é¢ã‚„çª“ã‚’æ´»ç”¨ã€‚éƒ½å¸‚éƒ¨ã§ã®ç™ºé›»ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’æœ€å¤§åŒ–ã—ã¾ã™ã€‚", stable: 2, cost: 3, env: 5, future: 5 },
            SOLAR_AGRI: { n: "å–¶è¾²å‹å¤ªé™½å…‰", c: "#f39c12", t: "è¾²åœ°ã®ä¸Šç©ºã‚’æ´»ç”¨ã€‚è¾²æ¥­ã¨ç™ºé›»ã‚’ä¸¡ç«‹ã™ã‚‹åœ°åŸŸæ´»æ€§åŒ–ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚", stable: 2, cost: 4, env: 5, future: 4 },
            HYDRO_SMALL: { n: "ä¸­å°æ°´åŠ›ç™ºé›»", c: "#16a085", t: "æ²³å·ã®è‡ªç„¶ãªæµã‚Œã‚’æ´»ã‹ã—ã€24æ™‚é–“æ­¢ã¾ã‚‰ãªã„é›»åŠ›ã‚’ä¾›çµ¦ã—ã¾ã™ã€‚", stable: 5, cost: 3, env: 5, future: 3 },
            BIO_WOOD: { n: "æ£®æ—æœ¨è³ªãƒã‚¤ã‚ªãƒã‚¹", c: "#27ae60", t: "é–“ä¼æã®åˆ©æ´»ç”¨ã«ã‚ˆã‚Šæ£®ã‚’å†ç”Ÿã—ã€ç†±ã¨é›»æ°—ã‚’å‰µå‡ºã—ã¾ã™ã€‚", stable: 5, cost: 3, env: 4, future: 3 },
            BIO_GAS: { n: "å»ƒæ£„ç‰©ç³»ãƒã‚¤ã‚ªã‚¬ã‚¹", c: "#8e44ad", t: "éƒ½å¸‚ã®ç”Ÿã‚´ãƒŸã‚„æ±šæ³¥ã‚’æ´»ç”¨ã€‚è³‡æºå¾ªç’°å‹ç¤¾ä¼šã®è¦ã¨ãªã‚‹é›»æºã§ã™ã€‚", stable: 5, cost: 3, env: 5, future: 3 },
            SNOW: { n: "é›ªæ°·ç†±ã‚¨ãƒãƒ«ã‚®ãƒ¼åˆ©ç”¨", c: "#a2deff", t: "å†¬ã®é›ªã‚’å¤ã®å†·æˆ¿ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«å¤‰ãˆã‚‹ã€é›ªå›½ç‹¬è‡ªã®çŸ¥æµã§ã™ã€‚", stable: 4, cost: 3, env: 5, future: 2 },
            HYDROGEN: { n: "ã‚°ãƒªãƒ¼ãƒ³æ°´ç´ è²¯è”µæ‹ ç‚¹", c: "#00cec9", t: "å†ã‚¨ãƒä½™å‰°åˆ†ã‚’æ°´ç´ ã¨ã—ã¦è²¯è”µã€‚å°†æ¥ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚¤ãƒ³ãƒ•ãƒ©ã®è¦ã§ã™ã€‚", stable: 4, cost: 1, env: 5, future: 5 },
            TIDAL: { n: "æ½®æµãƒ»æ½®æ±ç™ºé›»", c: "#0984e3", t: "å¼·ã„æ½®æµã‚’åˆ©ç”¨ã€‚æœˆã®æº€ã¡æ¬ ã‘ã«åŸºã¥ã„ãŸç¢ºå®Ÿãªäºˆæ¸¬ãŒå¯èƒ½ã§ã™ã€‚", stable: 4, cost: 1, env: 4, future: 4 }
        };

        const SEASON_FACTORS = {
            spring: { solar: 0.9, wind: 0.8, hydro: 1.0, bio: 1.0, geo: 1.0 },
            summer: { solar: 1.0, wind: 0.4, hydro: 0.8, bio: 1.0, geo: 1.0 },
            autumn: { solar: 0.7, wind: 0.7, hydro: 0.6, bio: 1.0, geo: 1.0 },
            winter: { solar: 0.5, wind: 1.0, hydro: 0.4, bio: 1.0, geo: 1.0 }
        };

        let map;
        let markers = [];
        let currentSeason = 'spring';
        let currentTime = 12;
        let currentData = null;
        let compareList = [];
        let timeBasedChart = null;

        function initMap() {
            map = L.map('map', {
                zoomControl: true,
                maxBounds: [[20, 120], [50, 155]],
                minZoom: 5
            }).setView([36.5, 138], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', (e) => {
                analyze(e.latlng.lat, e.latlng.lng);
            });
        }

        function showLoading() {
            const msg = LOADING_MESSAGES[Math.floor(Math.random() * LOADING_MESSAGES.length)];
            document.getElementById('loadingMessage').textContent = msg;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        async function analyze(lat, lon, customName) {
            showLoading();
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12`
                );
                const data = await response.json();
                const addr = data.address;
                const city = addr.city || addr.town || addr.village || addr.suburb || "åœ°åŸŸä¸æ˜";
                const pref = addr.province || addr.state || "";
                const fullName = customName || (pref + " " + city);

                let p = { solar: 25, wind: 20, geo: 10, hydro: 20, bio: 25 };

                if (pref.includes("å¤§åˆ†") || pref.includes("ç†Šæœ¬") || pref.includes("é¹¿å…å³¶") || pref.includes("ç¦å³¶") || pref.includes("ç§‹ç”°")) {
                    p.geo += 60;
                }
                if (pref.includes("åŒ—æµ·é“") || pref.includes("é’æ£®") || pref.includes("ç§‹ç”°") || pref.includes("å±±å½¢") || city.includes("æµ·") || city.includes("æ¸¯") || city.includes("å²¬")) {
                    p.wind += 50;
                }
                if (pref.includes("é•·é‡") || pref.includes("å²é˜œ") || pref.includes("å¯Œå±±") || pref.includes("çŸ³å·") || pref.includes("ç¦äº•") || city.includes("å±±") || city.includes("å·")) {
                    p.hydro += 45;
                }
                if (pref.includes("é«˜çŸ¥") || pref.includes("å®®å´") || pref.includes("å²©æ‰‹") || pref.includes("å¥ˆè‰¯")) {
                    p.bio += 40;
                }
                if (pref.includes("å±±æ¢¨") || pref.includes("é™å²¡") || pref.includes("ç¾¤é¦¬") || pref.includes("å²¡å±±") || city.includes("åŒº") || city.includes("å¸‚")) {
                    p.solar += 35;
                }

                let bestType = "SOLAR_AGRI";
                if (p.geo > 65) bestType = "GEO_FLASH";
                else if (p.hydro > 60) bestType = "HYDRO_SMALL";
                else if (p.wind > 65) bestType = (city.includes("æµ·") || city.includes("æ¸¯")) ? "WIND_OFFSHORE" : "WIND_ONSHORE";
                else if (p.bio > 55) bestType = "BIO_WOOD";
                else if (p.solar > 50) bestType = city.includes("åŒº") ? "SOLAR_ROOF" : "SOLAR_AGRI";
                else if (pref.includes("åŒ—æµ·é“") && currentSeason === 'winter') bestType = "SNOW";
                else bestType = "BIO_GAS";

                const res = MASTER_DATA[bestType];
                currentData = { lat, lon, name: fullName, p, res, bestType };

                addMarkerToMap(lat, lon, res, fullName);
                displayResult();
                hideLoading();
            } catch (error) {
                console.error('Analysis failed:', error);
                hideLoading();
            }
        }

        function addMarkerToMap(lat, lon, res, name) {
            const existing = markers.find(m => {
                const latlng = m.getLatLng();
                return Math.abs(latlng.lat - lat) < 0.001 && Math.abs(latlng.lng - lon) < 0.001;
            });

            if (existing) {
                existing.setStyle({ color: res.c, fillColor: res.c });
                existing.setPopupContent(`<strong>${name}</strong><br>æœ€é©: ${res.n}`);
                return;
            }

            const marker = L.circleMarker([lat, lon], {
                radius: 8,
                fillColor: res.c,
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            marker.bindPopup(`<strong>${name}</strong><br>æœ€é©: ${res.n}`);
            marker.on('click', () => {
                analyze(lat, lon, name);
            });
            markers.push(marker);
        }

        function displayResult() {
            if (!currentData) return;

            const sf = SEASON_FACTORS[currentSeason];
            const hourFactor = (currentTime >= 6 && currentTime <= 18) ? Math.sin((currentTime - 6) / 12 * Math.PI) : 0;

            // æ™‚é–“å¸¯ã”ã¨ã®ç™ºé›»é‡ã‚’è¨ˆç®—
            const timeBasedGeneration = {
                solar: currentData.p.solar * sf.solar * hourFactor,
                wind: currentData.p.wind * sf.wind * 0.8,
                geo: currentData.p.geo * sf.geo,
                hydro: currentData.p.hydro * sf.hydro,
                bio: currentData.p.bio * sf.bio
            };

            let html = `
                <div class="result-card">
                    <div class="energy-badge" style="background-color: ${currentData.res.c}">æœ€é©ã‚¨ãƒãƒ«ã‚®ãƒ¼</div>
                    <div class="result-title">${currentData.res.n}</div>
                    <div class="result-location">ğŸ“ ${currentData.name}</div>
                    <div class="result-description">${currentData.res.t}</div>
                    <button class="button" onclick="addToCompare()">æ¯”è¼ƒãƒªã‚¹ãƒˆã«è¿½åŠ </button>
                </div>

                <div class="time-based-chart">
                    <div class="chart-title">â° ${currentTime}:00 æ™‚ç‚¹ã§ã®ç™ºé›»é‡æ¨å®š</div>
                    <canvas id="timeBasedChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">åŸºæœ¬ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«åˆ†æ</div>
                    <canvas id="potentialChart"></canvas>
                </div>
            `;

            document.getElementById('result-container').innerHTML = html;

            // æ™‚é–“å¸¯ã”ã¨ã®ç™ºé›»é‡ãƒãƒ£ãƒ¼ãƒˆ
            const timeCtx = document.getElementById('timeBasedChart').getContext('2d');
            new Chart(timeCtx, {
                type: 'bar',
                data: {
                    labels: ['å¤ªé™½å…‰', 'é¢¨åŠ›', 'åœ°ç†±', 'æ°´åŠ›', 'ãƒã‚¤ã‚ªãƒã‚¹'],
                    datasets: [{
                        label: `${currentTime}:00 ã®ç™ºé›»é‡`,
                        data: [
                            timeBasedGeneration.solar,
                            timeBasedGeneration.wind,
                            timeBasedGeneration.geo,
                            timeBasedGeneration.hydro,
                            timeBasedGeneration.bio
                        ],
                        backgroundColor: ['#f1c40f', '#3498db', '#c0392b', '#16a085', '#27ae60'],
                        borderColor: ['#f39c12', '#2980b9', '#a93226', '#117a65', '#1e8449'],
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    scales: { x: { min: 0, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });

            // ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«åˆ†æãƒãƒ£ãƒ¼ãƒˆ
            const potentialCtx = document.getElementById('potentialChart').getContext('2d');
            new Chart(potentialCtx, {
                type: 'radar',
                data: {
                    labels: ['å¤ªé™½å…‰', 'é¢¨åŠ›', 'åœ°ç†±', 'æ°´åŠ›', 'ãƒã‚¤ã‚ªãƒã‚¹'],
                    datasets: [{
                        label: 'åŸºæœ¬ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«',
                        data: [currentData.p.solar, currentData.p.wind, currentData.p.geo, currentData.p.hydro, currentData.p.bio],
                        backgroundColor: 'rgba(101, 163, 13, 0.2)',
                        borderColor: 'rgba(101, 163, 13, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 100 } },
                    maintainAspectRatio: false
                }
            });
        }

        function updateTime(value) {
            currentTime = parseInt(value);
            document.getElementById('timeValue').textContent = String(currentTime).padStart(2, '0');
            if (currentData) {
                displayResult();
            }
        }

        function setSeason(season) {
            currentSeason = season;
            document.querySelectorAll('.season-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            if (currentData) {
                displayResult();
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function addToCompare() {
            if (!currentData) return;
            if (compareList.length >= 5) {
                alert("æ¯”è¼ƒãƒªã‚¹ãƒˆã¯æœ€å¤§5ç®‡æ‰€ã¾ã§ã§ã™ã€‚");
                return;
            }
            if (compareList.find(item => item.name === currentData.name)) {
                alert("æ—¢ã«ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚");
                return;
            }
            compareList.push(JSON.parse(JSON.stringify(currentData)));
            updateCompareList();
        }

        function removeFromCompare(index) {
            compareList.splice(index, 1);
            updateCompareList();
        }

        function updateCompareList() {
            document.getElementById('compareCount').textContent = compareList.length;
            let html = '';
            compareList.forEach((item, idx) => {
                html += `
                    <div class="compare-item">
                        <span>${item.name}</span>
                        <button class="compare-item-remove" onclick="removeFromCompare(${idx})">å‰Šé™¤</button>
                    </div>
                `;
            });
            document.getElementById('compareList').innerHTML = html;
            document.getElementById('compareButton').disabled = compareList.length < 2;
        }

        function executeComparison() {
            if (compareList.length < 2) {
                alert("2ç®‡æ‰€ä»¥ä¸Šã‚’æ¯”è¼ƒã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const comparisonData = compareList.map(item => ({
                name: item.name,
                stability: item.res.stable,
                cost: item.res.cost,
                env: item.res.env,
                future: item.res.future,
                total: item.res.stable + item.res.cost + item.res.env + item.res.future
            }));

            const bestByStability = comparisonData.reduce((a, b) => a.stability > b.stability ? a : b);
            const bestByCost = comparisonData.reduce((a, b) => a.cost > b.cost ? a : b);
            const bestByEnv = comparisonData.reduce((a, b) => a.env > b.env ? a : b);
            const bestByFuture = comparisonData.reduce((a, b) => a.future > b.future ? a : b);
            const bestOverall = comparisonData.reduce((a, b) => a.total > b.total ? a : b);

            let html = `
                <div class="compare-results">
                    <h3 style="margin-bottom: 15px; color: #0066cc;">ğŸ† æ¯”è¼ƒçµæœ</h3>
                    <div class="result-item"><strong>å®‰å®šæ€§æœ€é«˜:</strong> ${bestByStability.name}</div>
                    <div class="result-item"><strong>ã‚³ã‚¹ãƒˆåŠ¹ç‡:</strong> ${bestByCost.name}</div>
                    <div class="result-item"><strong>ç’°å¢ƒè©•ä¾¡:</strong> ${bestByEnv.name}</div>
                    <div class="result-item"><strong>å°†æ¥æ€§:</strong> ${bestByFuture.name}</div>
                    <div class="result-item" style="background: #fff9e6; border-left: 3px solid #f1c40f;"><strong>ç·åˆè©•ä¾¡:</strong> ${bestOverall.name}</div>
                </div>
            `;
            document.getElementById('compareResults').innerHTML = html;
        }

        window.addEventListener('load', initMap);
    </script>
</body>
</html>
