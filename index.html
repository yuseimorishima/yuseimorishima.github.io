<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒãƒ«ã‚®ãƒ¼è§£æãƒ„ãƒ¼ãƒ« - åœ°åŸŸãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«å¯è¦–åŒ–</title>
    
    <meta property="og:title" content="ã‚¨ãƒãƒ«ã‚®ãƒ¼è§£æãƒ„ãƒ¼ãƒ« - åœ°åŸŸãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«å¯è¦–åŒ–">
    <meta property="og:description" content="åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãã®å ´æ‰€ã«æœ€é©ãªå†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’AIãŒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‚">
    <meta property="og:type" content="website">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .map-section {
            flex: 1;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .sidebar {
            width: 450px;
            background: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        /* --- ã‚¹ãƒãƒ›å¯¾å¿œï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼‰CSS --- */
        @media (max-width: 768px) {
            .container {
                flex-direction: column; /* ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
            }
            .map-section {
                height: 40vh; /* åœ°å›³ã®é«˜ã•ã‚’ç”»é¢ã®40%ã«å›ºå®š */
                flex: none;
            }
            .sidebar {
                width: 100%;
                flex: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’è§£æã‚¨ãƒªã‚¢ã« */
                border-left: none;
                border-top: 1px solid #ddd;
            }
        }

        /* ã‚¿ãƒ–ãƒ»ãƒœã‚¿ãƒ³ãƒ»ã‚«ãƒ¼ãƒ‰ãªã©ã®è£…é£¾ */
        .tabs { display: flex; border-bottom: 1px solid #ddd; sticky: top; background: white; z-index: 10; }
        .tab-button { flex: 1; padding: 15px; background: none; border: none; cursor: pointer; font-weight: bold; color: #666; border-bottom: 3px solid transparent; }
        .tab-button.active { color: #0066cc; border-bottom-color: #0066cc; background: #f9f9f9; }
        .tab-content { padding: 20px; display: none; }
        .tab-content.active { display: block; }
        
        .control-group { margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px; }
        .season-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .season-btn { padding: 8px; border: 2px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .season-btn.active { background: #0066cc; color: white; border-color: #0066cc; }
        
        .result-card { border: 2px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .energy-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; color: white; font-size: 11px; font-weight: bold; margin-bottom: 10px; }
        
        .chart-container, .time-based-chart { height: 250px; margin-bottom: 15px; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 10px; }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .loading-overlay.active { display: flex; }
        .loading-box { background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 80%; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0066cc; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .button { width: 100%; padding: 12px; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body onload="initMap()">
    <div class="container">
        <div class="map-section">
            <div id="map"></div>
        </div>
        
        <div class="sidebar">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('analyze')">åœ°ç‚¹è§£æ</button>
                <button class="tab-button" onclick="switchTab('compare')">æ¯”è¼ƒ (<span id="compareCount">0</span>)</button>
            </div>
            
            <div style="padding: 15px; border-bottom: 1px solid #ddd;">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="searchInput" placeholder="åœ°åã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šç®±æ ¹ï¼‰" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    <button onclick="searchLocation()" style="padding: 10px 15px; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer;">æ¤œç´¢</button>
                </div>
            </div>
            
            <div id="analyze-tab" class="tab-content active">
                <div class="control-group">
                    <label style="font-size: 13px; font-weight: bold; margin-bottom: 8px; display: block;">è§£æå­£ç¯€</label>
                    <div class="season-buttons">
                        <button class="season-btn active" onclick="setSeason('spring')">æ˜¥</button>
                        <button class="season-btn" onclick="setSeason('summer')">å¤</button>
                        <button class="season-btn" onclick="setSeason('autumn')">ç§‹</button>
                        <button class="season-btn" onclick="setSeason('winter')">å†¬</button>
                    </div>
                </div>

                <div class="control-group">
                    <div style="display: flex; justify-content: space-between;">
                        <label style="font-size: 13px; font-weight: bold;">è§£ææ™‚é–“å¸¯</label>
                        <span style="color: #0066cc; font-weight: bold;"><span id="timeValue">12</span>:00</span>
                    </div>
                    <input type="range" id="timeSlider" min="0" max="23" value="12" style="width: 100%; margin-top: 10px;" onchange="updateTime(this.value)">
                </div>

                <div id="result-container">
                    <div style="text-align: center; color: #999; padding: 40px 0;">
                        <p>ğŸ—ºï¸ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã‹åœ°åã‚’æ¤œç´¢ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>
            
            <div id="compare-tab" class="tab-content">
                <div id="compareList"></div>
                <button class="button" onclick="executeComparison()" id="compareButton" disabled>ç·åˆæ¯”è¼ƒã‚’å®Ÿè¡Œ</button>
                <div id="compareResults"></div>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <p id="loadingMessage" style="font-size: 14px; line-height: 1.6;">AIãŒè§£æã—ã¦ã„ã¾ã™...</p>
        </div>
    </div>

    <script>
        // ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿ã¯ã“ã“ã‹ã‚‰
        const MASTER_DATA = {
            GEO_FLASH: { n: "åœ°ç†±ï¼ˆå¤§å®¹é‡ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰", c: "#c0392b", t: "ç«å±±å¸¯ã®å¼·åŠ›ãªè’¸æ°—ã‚’æ´»ç”¨ã€‚24æ™‚é–“å®‰å®šã—ãŸå‡ºåŠ›ãŒå¯èƒ½ã§ã™ã€‚", stable: 5, cost: 3, env: 5, future: 4 },
            WIND_OFFSHORE: { n: "æ´‹ä¸Šé¢¨åŠ›ç™ºé›»", c: "#2980b9", t: "æµ·ä¸Šã®å¼·åŠ›ãªé¢¨ã‚’é›»æ°—ã«å¤‰ãˆã¾ã™ã€‚å°†æ¥ã®ä¸»åŠ›é›»æºã§ã™ã€‚", stable: 3, cost: 2, env: 4, future: 5 },
            SOLAR_AGRI: { n: "å–¶è¾²å‹å¤ªé™½å…‰", c: "#f39c12", t: "è¾²åœ°ã®ä¸Šç©ºã§ç™ºé›»ã€‚è¾²æ¥­ã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®å…±ç”Ÿãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚", stable: 2, cost: 4, env: 5, future: 4 },
            HYDRO_SMALL: { n: "ä¸­å°æ°´åŠ›ç™ºé›»", c: "#16a085", t: "æ²³å·ã®è‡ªç„¶ãªæµã‚Œã‚’æ´»ã‹ã—ãŸã€åœ°åŸŸå¯†ç€å‹ã®å®‰å®šé›»æºã€‚", stable: 5, cost: 3, env: 5, future: 3 },
            BIO_WOOD: { n: "æœ¨è³ªãƒã‚¤ã‚ªãƒã‚¹", c: "#27ae60", t: "é–“ä¼æã‚’åˆ©ç”¨ã€‚æ£®ã®å†ç”Ÿã¨ã‚¨ãƒãƒ«ã‚®ãƒ¼å‰µå‡ºã‚’ä¸¡ç«‹ã—ã¾ã™ã€‚", stable: 5, cost: 3, env: 4, future: 3 }
            // â€»å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã—ã¦ãã ã•ã„
        };

        const SEASON_FACTORS = {
            spring: { solar: 0.9, wind: 0.8, hydro: 1.0, bio: 1.0, geo: 1.0 },
            summer: { solar: 1.0, wind: 0.4, hydro: 0.8, bio: 1.0, geo: 1.0 },
            autumn: { solar: 0.7, wind: 0.7, hydro: 0.6, bio: 1.0, geo: 1.0 },
            winter: { solar: 0.5, wind: 1.0, hydro: 0.4, bio: 1.0, geo: 1.0 }
        };

        let map, currentSeason = 'spring', currentTime = 12, currentData = null, compareList = [];

        function initMap() {
            map = L.map('map').setView([36.5, 138], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', (e) => analyze(e.latlng.lat, e.latlng.lng));
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        async function analyzeWithMinTime(lat, lon, customName, searchStartTime) {
            document.getElementById('loadingOverlay').classList.add('active');
            const analyzeStartTime = Date.now();
            const MIN_LOADING_TIME = 2000; // æœ€ä½2ç§’ã¯ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¦‹ã›ã‚‹

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12`);
                const data = await response.json();
                const addr = data.address;
                const city = addr.city || addr.town || addr.village || addr.suburb || "åœ°åŸŸä¸æ˜";
                const pref = addr.province || addr.state || "";
                const fullName = customName || (pref + " " + city);

                let p = { solar: 25, wind: 20, geo: 10, hydro: 20, bio: 25 };

                if (pref.includes("å¤§åˆ†") || pref.includes("ç†Šæœ¬") || pref.includes("é¹¿å…å³¶") || pref.includes("ç¦å³¶") || pref.includes("ç§‹ç”°")) {
                    p.geo += 60;
                }
                if (pref.includes("åŒ—æµ·é“") || pref.includes("é’æ£®") || pref.includes("ç§‹ç”°") || pref.includes("å±±å½¢") || city.includes("æµ·") || city.includes("æ¸¯") || city.includes("å²¬")) {
                    p.wind += 50;
                }
                if (pref.includes("é•·é‡") || pref.includes("å²é˜œ") || pref.includes("å¯Œå±±") || pref.includes("çŸ³å·") || pref.includes("ç¦äº•") || city.includes("å±±") || city.includes("å·")) {
                    p.hydro += 45;
                }
                if (pref.includes("é«˜çŸ¥") || pref.includes("å®®å´") || pref.includes("å²©æ‰‹") || pref.includes("å¥ˆè‰¯")) {
                    p.bio += 40;
                }
                if (pref.includes("å±±æ¢¨") || pref.includes("é™å²¡") || pref.includes("ç¾¤é¦¬") || pref.includes("å²¡å±±") || city.includes("åŒº") || city.includes("å¸‚")) {
                    p.solar += 35;
                }

                let bestType = "SOLAR_AGRI";
                if (p.geo > 65) bestType = "GEO_FLASH";
                else if (p.hydro > 60) bestType = "HYDRO_SMALL";
                else if (p.wind > 65) bestType = (city.includes("æµ·") || city.includes("æ¸¯")) ? "WIND_OFFSHORE" : "WIND_ONSHORE";
                else if (p.bio > 55) bestType = "BIO_WOOD";
                else if (p.solar > 50) bestType = city.includes("åŒº") ? "SOLAR_ROOF" : "SOLAR_AGRI";
                else if (pref.includes("åŒ—æµ·é“") && currentSeason === 'winter') bestType = "SNOW";
                else bestType = "BIO_GAS";

                const res = MASTER_DATA[bestType];
                currentData = { lat, lon, name: fullName, p, res, bestType };

                addMarkerToMap(lat, lon, res, fullName);
                displayResult();
                
                const elapsedTime = Date.now() - analyzeStartTime;
                if (elapsedTime < MIN_LOADING_TIME) {
                    await new Promise(resolve => setTimeout(resolve, MIN_LOADING_TIME - elapsedTime));
                }
                hideLoading();
            } catch (error) {
                console.error('Analysis failed:', error);
                
                const elapsedTime = Date.now() - analyzeStartTime;
                if (elapsedTime < MIN_LOADING_TIME) {
                    await new Promise(resolve => setTimeout(resolve, MIN_LOADING_TIME - elapsedTime));
                }
                hideLoading();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
        });

        window.addEventListener('load', initMap);
    </script>
</body>
</html>
